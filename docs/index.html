<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Util GDE</title>

<!-- Bootswatch Darkly -->
<link rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.2/dist/darkly/bootstrap.min.css">

<!-- JSONEditor -->
<script src="https://cdn.jsdelivr.net/npm/@json-editor/json-editor@latest/dist/jsoneditor.min.js"></script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- sjcl -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/sjcl/1.0.8/sjcl.js"></script>


<style>
    body {
        background: #1a1c1e;
    }
    #editorPanel {
        max-width: 900px;
        margin: 20px auto;
    }
</style>
</head>

<body>

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="#">Util GDE</a>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navContent">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navContent">
      <ul class="navbar-nav me-auto">

        <!-- SelecciÃ³n del schema -->
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="schemaMenu" role="button" data-bs-toggle="dropdown">
            Configuraciones
          </a>
          <ul class="dropdown-menu" id="schemaList">
            <!-- Se llenarÃ¡ por JS -->
          </ul>
        </li>

      </ul>

      <!-- Botones -->
      <div class="d-flex">
        <button id="btnSave" class="btn btn-primary me-2">ðŸ’¾ Guardar</button>
        <button id="btnDownload" class="btn btn-info me-2">ðŸ“¥ Descargar</button>
        <button id="btnReset" class="btn btn-danger">â™» Resetear</button>
      </div>

    </div>
  </div>
</nav>


<!-- PANEL DEL EDITOR -->
<div id="editorPanel" class="card border-primary bg-dark text-light shadow">
    <div class="card-header bg-primary text-white fw-bold">
        Editando configuraciÃ³n de <span id="currentSchemaName"></span>
    </div>

    <div id="editorHolder" class="card-body bg-light text-dark" style="min-height:300px;">
        <!-- JSON Editor se monta aquÃ­ -->
    </div>
</div>

<!-- Modal para ingresar clave -->
<div class="modal fade" id="passwordModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title">Clave requerida</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <label for="passwordInput" class="form-label">Ingrese la clave:</label>
        <input type="password" id="passwordInput" class="form-control">
        <div id="passwordError" class="text-danger mt-2 d-none">
          Debe ingresar una clave.
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" id="passwordConfirmBtn" class="btn btn-info">Aceptar</button>
      </div>
    </div>
  </div>
</div>



<script>
/*******************************************************
 * 1) DefiniciÃ³n de mÃºltiples schemas
 *******************************************************/
const schemas = {
    usuario: {
        title: "Usuario",
        type: "object",
        properties: {
            nombre: { type: "string" },
            apellido: { type: "string" },
            cuil: { type: "number" },
            usuario_gde: { type: "string" },
        }
    },

    domicilio: {
        title: "Domicilio",
        type: "object",
        properties: {
            calle: { type: "string" },
            numero: { type: "string" },
            piso: { type: "string" },
            departamento: { type: "string" },
            localidad: { type: "string" },
            telefono: { type: "string" },
        }
    },

    datos_revista: {
        title: "SituaciÃ³n de revista",
        type: "object",
        properties: {
            convenio: { type: "string",
                "enum": [
                    "SINEP",
                    "Contrato 1421/2",
                    "Extraescalafonario",
                    "Planta Transitoria",
                    "DesignaciÃ³n Transitoria",
                    "Convenio 973: Orquestas, Coros y Ballets Nacionales",
                    "Convenio 1133/09",
                    "Convenio 2539/15 Personal Civil y Docente Civil de las Fuerzas Armadas y de Seguridad",
                    "Otros"
                ]
             },
            reparticion: { type: "string" },
        }
    },

    fsoli: {
        title: "Datos FSOLI",
        type: "object",
        properties: {
            destinatarios: { type: "string" },
            cc: { type: "string" },
            cco: { type: "string" }
        }
    }

    
};

/*******************************************************
 * 2) Rellenar el menÃº de schemas dinÃ¡micamente
 *******************************************************/
const schemaList = document.getElementById("schemaList");

Object.keys(schemas).forEach(key => {
    const li = document.createElement("li");
    const a = document.createElement("a");
    console.log( schemas[key] )
    a.className = "dropdown-item";
    a.href = "#";
    a.textContent = schemas[key].title  || key;
    a.onclick = () => loadSchema(key);
    li.appendChild(a);
    schemaList.appendChild(li);
});


function decryptLocalStorage( solicitarClave = false) {
    var data_saved = null;
    console.log( "Solicitar clave: ", solicitarClave);
    if ( solicitarClave || localStorage.getItem(prefix_data) !== null  ) {
        pedirClave().then(password => {
            console.log( password )
            if (!password) return "";  // por si cancela
            try {
                const encrypted = localStorage.getItem(prefix_data);
                if( password != 'pwd'){
                    data_saved = sjcl.decrypt(password, encrypted);
                } else {
                    data_saved = encrypted;
                }   
            } catch (err) {
                alert("Clave incorrecta o datos corruptos.");
            }
        })
    } else {
      console.log( "Datos GDE vacÃ­o");
    };   
    return data_saved
};




/*******************************************************
 * 3) Variables del editor
 *******************************************************/
let editor = null;
let currentSchemaKey = null;
JSONEditor.defaults.options.iconlib = "fontawesome5";
JSONEditor.defaults.options.theme = "bootstrap5";
JSONEditor.defaults.options.disable_edit_json = true;
JSONEditor.defaults.options.disable_properties = true;
JSONEditor.defaults.options.display_required_only = false;


/*******************************************************
 * 4) Cargar schema con persistencia por clave
 *******************************************************/

const prefix_data = "utilGDE_data_"
let allValues = {}
let oldKey = ""

function loadSchema(key) {
    currentSchemaKey = key;
    
    document.getElementById("currentSchemaName").textContent = schemas[key].title || key;

    //const raw = decryptLocalStorage();

    let startval = null;
    if (raw) {
        try {
            allValues = JSON.parse(raw); 
            startval =  allValues[key]
        }
        catch { startval = null; }
    }

    // Destruir editor previo
    if (editor) {
        if( oldKey != "")
            allValues[oldKey] = editor.getValue() ?? {} ;
        console.log( JSON.stringify( allValues ));
        editor.destroy();
        editor = null;
    }

    // Crear editor nuevo
    oldKey = key;
    editor = new JSONEditor(document.getElementById("editorHolder"), {
        schema: schemas[key],
        startval: allValues[key] ?? undefined,
        required_by_default : true
        });

    // Guardado automÃ¡tico 
    /*
    editor.on("change", () => {
        localStorage.setItem(
            prefix_data + key,
            JSON.stringify(editor.getValue())
        );
    });*/
};





/*******************************************************
 * 5a) BotÃ³n Guardar
  *******************************************************/
document.getElementById("btnSave").onclick = () => {
    
        pedirClave(true).then(password => {
            if (!password) return;  // por si cancela

            //TODO: recolectar todos los valores 
            //const rawJson = JSON.stringify(editor.getValue());
            const rawJson = JSON.stringify(allValues);

            // Cifrado con SJCL (AES+PBKDF2+CCM)
            const encrypted = sjcl.encrypt(password, rawJson, {
                ks: 256,      // tamaÃ±o de clave 256 bits
                iter: 100000  // iterations PBKDF2
            });

            //localStorage.setItem(prefix_data , encrypted);
            //localStorage.setItem(prefix_data + "_savedAt", new Date().toISOString());

            localStorage.setItem(prefix_data , rawJson)
    });
};


/*******************************************************
 * 5b) BotÃ³n Descargar
 *******************************************************/
document.getElementById("btnDownload").onclick = () => {
    //if (!editor) return;

    var data_saved = decryptLocalStorage(true);
    console.log( "Descarga" , data_saved )

    if( data_saved != null ){
        const blob = new Blob([JSON.stringify(data_saved, null, 2)], {
        type: "application/json"
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = prefix_data + ".json";
        a.click();
        URL.revokeObjectURL(url);
    }
};


/*******************************************************
 * 6) BotÃ³n Reset
 *******************************************************/
document.getElementById("btnReset").onclick = () => {
    try {
        const ok = confirm("Â¿Seguro que deseas borrar los datos?");
        if (ok) {
            localStorage.removeItem(prefix_data);
            editor.setValue({});
            alert("Datos eliminados");
        }
    } catch (error) {
        console.error("No se puede borrar", error);
    }
};
  

/*******************************************************
 * 8) Funciones auxiliares 
 *******************************************************/
function pedirClave() {
    return new Promise(resolve => {
        const modalEl = document.getElementById("passwordModal");
        const input = document.getElementById("passwordInput");
        const error = document.getElementById("passwordError");
        const confirmBtn = document.getElementById("passwordConfirmBtn");

        // Reset
        input.value = "";
        error.classList.add("d-none");

        // Crear instancia del modal
        const modal = new bootstrap.Modal(modalEl);

        // Evento al confirmar
        confirmBtn.onclick = () => {
            const value = input.value.trim();
            if (!value) {
                error.classList.remove("d-none");
                return;
            }
            modal.hide();        // cerrar modal
            resolve(value);      // devolver clave
        };

        modal.show();
    });
}

/*******************************************************
 * 7) Cargar el primer schema automÃ¡ticamente
 *******************************************************/
const raw = decryptLocalStorage();
if (raw) {
    try {
        allValues = JSON.parse(raw); 
    }
    catch { startval = null; }
}

loadSchema(Object.keys(schemas)[0]);

</script>

</body>
</html>
